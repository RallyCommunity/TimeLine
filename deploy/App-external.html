<!DOCTYPE html>
<html>
<head>
    <title>TimeLine</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk-debug.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",inheritableStatics:{ErrorColour:"tomato",WarnColour:"orangered",PassColour:"lightgreen",DoneColour:"silver",ToDoColour:"salmon",HdrColour:"lightgray",DataError:"red",DaysPerMonth:[31,28,31,30,31,30,31,31,30,31,30,31],TreeBoxWidth:200,StandardBarHeight:30},items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,layout:"hbox",items:[{xtype:"rallyportfolioitemtypecombobox",margin:10,id:"piType"},{xtype:"rallydatefield",margin:10,format:"D d M Y",id:"StartDate",stateful:!0,fieldLabel:"Start Date",value:Ext.Date.subtract(new Date,Ext.Date.DAY,90)},{xtype:"rallydatefield",margin:10,fieldLabel:"End Date",format:"D d M Y",stateful:!0,id:"EndDate",value:new Date}]},{xtype:"container",layout:"hbox",margin:10,items:[{xtype:"rallybuttonslider",labelText:"Zoom",id:"zoomSlider",stateful:!0,value:10}]}]}],zoomLevel:1,_resetTreeBox:function(app){var tb=Ext.getCmp("treeBox");app._destroyBars(tb.id),tb.add({xtype:"timeLineBar",html:"Name",colour:CustomApp.HdrColour,width:"100%",margin:"10 0 10 0"})},_destroyBars:function(boxTitle){var box=Ext.getCmp(boxTitle);box&&box.removeAll()},_resizeAllBars:function(){this._destroyBars("monthBox"),this._drawMonthBars(),this._destroyBars("lineBox"),this._redrawTimeLines(this,Ext.getCmp("piType").getRecord().get("TypePath"))},launch:function(){var app=this,slider=Ext.getCmp("zoomSlider"),lb=slider.getLeftButton(),rb=slider.getRightButton(),sl=slider.getSlider();rb.on("click",function(){app.zoomLevel+=1,app.zoomLevel>10&&(app.zoomLevel=10),sl.setValue(10*app.zoomLevel),app._resizeAllBars()}),lb.on("click",function(){app.zoomLevel-=1,0>=app.zoomLevel&&(app.zoomLevel=1),sl.setValue(10*app.zoomLevel),app._resizeAllBars()}),sl.on("changecomplete",function(slider,value,that){app.zoomLevel=Math.trunc(value/10),app._resizeAllBars()}),Ext.getCmp("StartDate").on("select",app._resizeAllBars,app),Ext.getCmp("EndDate").on("select",app._resizeAllBars,app);var timeLineBox=Ext.create("Ext.container.Container",{layout:"hbox",items:[{xtype:"container",id:"treeBox",width:this.self.TreeBoxWidth-4,autoScroll:!1},{xtype:"container",layout:"vbox",items:[{xtype:"container",id:"monthBox",layout:"hbox",margin:"10 0 10 0"},{xtype:"container",autoSize:!0,id:"lineBox"}],flex:1,autoScroll:!0}],listeners:{render:this._headerRendered,scope:app}});this.add(timeLineBox);var pitype=Ext.getCmp("piType").on("select",function(){app._redrawTimeLines(app,this.getRecord().get("TypePath"))})},onTimeBoxScopeChange:function(newScope){this._redrawTimeLines(this,Ext.getCmp("piType").getRecord().get("TypePath"))},_redrawTimeLines:function(app,type){var filters=[],timeboxScope=app.getContext().getTimeboxScope();timeboxScope&&filters.push(timeboxScope.getQueryFilter());var itemStore=Ext.create("Rally.data.wsapi.Store",{model:type,autoLoad:!0,filters:filters,listeners:{load:function(store,data,success){var stats=app._calcTimeStats(),timeLineBox=Ext.getCmp("lineBox"),treeBox=Ext.getCmp("treeBox");app._destroyBars(timeLineBox.id),app._resetTreeBox(app);var today=new Date;_.each(data,function(item){var box=Ext.create("Ext.container.Container",{id:"timeLineBox-"+item.get("FormattedID")});box.addCls("tlBox"),box.height=CustomApp.StandardBarHeight;var record={};record.colour=CustomApp.HdrColour,record.title="",record.width=0,record.height=Math.floor(CustomApp.StandardBarHeight/2),record.margin=0;var plannedStart=null,plannedEnd=null;item.get("PlannedStartDate")&&item.get("PlannedEndDate")?(plannedStart=new Date(item.get("PlannedStartDate")),plannedEnd=new Date(item.get("PlannedEndDate")),startBetween=Ext.Date.between(plannedStart,stats.start,stats.end),endBetween=Ext.Date.between(plannedEnd,stats.start,stats.end),!startBetween&&endBetween?(record.leftMargin=0,record.width=Ext.Date.getElapsed(stats.start,plannedEnd)/864e5*stats.pixelsPerDay):startBetween&&!endBetween?(record.leftMargin=Ext.Date.getElapsed(stats.start,plannedStart)/864e5*stats.pixelsPerDay,record.width=Ext.Date.getElapsed(plannedStart,stats.end)/864e5*stats.pixelsPerDay):startBetween&&endBetween&&(record.leftMargin=Ext.Date.getElapsed(stats.start,plannedStart)/864e5*stats.pixelsPerDay,record.width=Ext.Date.getElapsed(plannedStart,plannedEnd)/864e5*stats.pixelsPerDay)):record.colour=CustomApp.DataError;var plannedBar=app._createBar(record);plannedBar.addCls("planBar"),box.add(plannedBar);var percentComplete=Math.floor(100*item.get("PercentDoneByStoryPlanEstimate"));if(record.colour=CustomApp.ToDoColour,record.margin=0,record.width=0,record.title="",item.get("ActualStartDate")&&item.get("ActualEndDate"))record.colour=CustomApp.DoneColour;else{item.get("ActualStartDate")?(record.title=percentComplete+"%",colourStart=item.get("ActualStartDate")):colourStart=item.get("PlannedEndDate")?item.get("PlannedStartDate"):today,colourEnd=item.get("ActualEndDate")?item.get("ActualEndDate"):item.get("PlannedEndDate")?item.get("PlannedEndDate"):today;var totalElapsed=colourEnd-colourStart,acceptanceDelay=.2*totalElapsed,warningDelay=.2*totalElapsed;colourStartDate=new Date(colourStart),colourEndDate=new Date(colourEnd),yellowXStart=Ext.Date.add(colourStartDate,Ext.Date.MILLI,acceptanceDelay),redXStart=Ext.Date.add(colourStartDate,Ext.Date.MILLI,acceptanceDelay+warningDelay),yellowSlope=100/(colourEnd-yellowXStart),redSlope=100/(colourEnd-redXStart),redThreshold=redSlope*(today-redXStart),yellowThreshold=yellowSlope*(today-yellowXStart),yellowThreshold>percentComplete&&(record.colour=CustomApp.WarnColour),redThreshold>percentComplete&&(record.colour=CustomApp.ErrorColour),today>colourEnd&&(record.colour=percentComplete>=100?CustomApp.DoneColour:CustomApp.ErrorColour);var actualStart=new Date(item.get("ActualStartDate")),actualEnd=new Date(item.get("ActualEndDate"));startBetween=Ext.Date.between(actualStart,stats.start,stats.end),endBetween=Ext.Date.between(actualEnd,stats.start,stats.end),!startBetween&&endBetween?(record.leftMargin=0,record.width=Ext.Date.getElapsed(stats.start,actualEnd?actualEnd:today)/864e5*stats.pixelsPerDay):startBetween&&!endBetween?(record.leftMargin=Ext.Date.getElapsed(stats.start,actualStart)/864e5*stats.pixelsPerDay,record.width=Ext.Date.getElapsed(actualStart,item.get("ActualEndDate")?stats.end:today)/864e5*stats.pixelsPerDay):startBetween&&endBetween&&(record.leftMargin=Ext.Date.getElapsed(stats.start,actualStart)/864e5*stats.pixelsPerDay,record.width=Ext.Date.getElapsed(actualStart,actualEnd)/864e5*stats.pixelsPerDay);var actualBar=app._createBar(record);actualBar.addCls("actualBar"),box.add(actualBar),timeLineBox.add(box)}var titleRec={};titleRec.colour=CustomApp.HdrColour,titleRec.leftMargin=0,titleRec.width="100%",titleRec.title=item.get("FormattedID")+": "+item.get("Name");var titleBox=app._createBar(titleRec);titleBox.addCls("tltBox"),treeBox.add(titleBox)})}}})},_calcTimeStats:function(){var stats={};stats.start=new Date(Ext.Date.getFirstDateOfMonth(Ext.getCmp("StartDate").value)),stats.end=new Date(Ext.Date.getLastDateOfMonth(Ext.getCmp("EndDate").value)),stats.daysDuration=(stats.end-stats.start)/864e5,stats.daysDuration=stats.daysDuration>31?stats.daysDuration:31;var pixelsPerDay=(this.getWidth()-this.self.TreeBoxWidth)/(stats.daysDuration>0?stats.daysDuration:1)*this.zoomLevel;return stats.pixelsPerDay=pixelsPerDay>1?pixelsPerDay:1,stats},_drawMonthBars:function(){var record={},monthBox=Ext.getCmp("monthBox");for(stats=this._calcTimeStats(),monthNum=stats.start.getMonth(),lDate=stats.start,lDays=0;stats.daysDuration>lDays;)record.title=Ext.Date.format(lDate,"M Y"),record.colour=CustomApp.HdrColour,record.width=this.self.DaysPerMonth[monthNum]*stats.pixelsPerDay,mnth=this._createBar(record),mnth.addCls("mnthBox"),monthBox.add(mnth),lDays+=this.self.DaysPerMonth[monthNum],lDate=Ext.Date.add(lDate,Ext.Date.DAY,this.self.DaysPerMonth[monthNum]),monthNum+=1,monthNum>11&&(monthNum=0)},_createBar:function(record){return margin="0 0 0 "+record.leftMargin,bar=Ext.create("Rally.app.CustomTimeLineBar",{id:"TimeLineBar-"+Ext.id(),margin:margin,html:record.title,width:record.width,height:record.height||CustomApp.StandardBarHeight,align:"center",valign:"middle"}),bar.setStyle({backgroundColor:record.colour}),bar},_headerRendered:function(){this._drawMonthBars(),this._resetTreeBox(this)}}),Ext.define("Rally.app.CustomTimeLineBar",{extend:"Ext.Component",alias:"widget.timeLineBar",constructor:function(config){this.mergeConfig(config),this.callParent(arguments)},config:{autoSize:!0,viewBox:!1,draggable:!1,height:CustomApp.StandardBarHeight,style:{font:"12px Helvetica, sans-serif",backgroundColor:CustomApp.HdrColour,textAlign:"center"}},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses">{[this.getFormattedId()]} {[this.getSeparator()]}{Name}</div>','<div class="rightSide">',"</div>",{canDrag:function(){return me.getCanDrag()},getActionsGear:function(){return me._buildActionsGearHtml()},getFormattedId:function(){var record=me.getRecord();return record.getField("FormattedID")?Rally.ui.renderer.RendererFactory.renderRecordField(record,"FormattedID"):""},getSeparator:function(){return this.getFormattedId()?"- ":""}})}});

            Rally.launchApp('CustomApp', {
                name:"TimeLine",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .tlBox{border-bottom:1px solid #bbbbbb;height:30px}.planBar{background-image:url(Images/progressbar.png);background-repeat:repeat-x;margin-top:5px}.actualBar{height:10px;padding-bottom:5px}.tltBox{border-bottom:1px solid #99BBE8}.mnthBox{border-left:1px solid #999999}
    </style>
</head>
<body>
</body>
</html>
